<% set_meta_tags :title => @organizer.name + t('.title'),
                   :description => t('.meta_description') + ' ' + @organizer.name + ' ' +  t('.meta_description2')%>

<% content_for :head do %>  
  <%= auto_discovery_link_tag( :rss, organizer_url(:format => 'rss') , {:title => @organizer.name + t('app.s') + ' ' + t('.organizers_event') + ' ' + t('app.at') + ' ' +  t('app.site_name')}) %>
<% end %>                     
                   

<%= open_graph_properties @organizer.name, 
                          request.protocol + request.host_with_port + @organizer.logotype.url(:large), 
                          organizer_path(@organizer, 
                          :only_path => false)  %>

<% if current_user %>
  <% membership = @organizer.memberships.find_by_user_id current_user.id %>
  <% if membership %>
    <div class = "user_message">

        <p>
        <% case membership.state %>
          <% when "admin" %>
            Du är administratör för <%= @organizer.name%>s arrangörssida.<br />
            <strong><%= link_to "Just nu finns det behörighetsärenden att agera på.", :anchor => :admin %></strong><br /><%= link_to "Ändra arrangörssidan eller dela ut behörigheter.", :anchor => :admin %>
          <% when "applied" %>
            Du har ansökt om att bli administratör för <%= @organizer.name%>s arrangörssida.  <%= link_to "Status...", membership_path(membership, :id => membership.id ) %>  
            <%= link_to "Ångra...", membership_regret_path(membership, :id => membership.id ), :method => :put %>
          <% when "nominated" %>
            <%= @organizer.name %> vill att du ska vara administratör. Kommentar från <% membership.nominated_by_id.name %>: <emphasis>Kommentar</emphasis>. 
          <% when "disposed" %>
          <% when "resigned" %>
          <% else %>
        <% end %>
        </p>

    </div>
  <% end %>
  

     
<% end #current_user %>



<div class = "page_heading">
  <% unless @organizer.logotype.blank? %>
    <%= image_tag @organizer.logotype.url(:medium),
                  :class => :page_logotype,
                  :alt => t('.logotype_for') + ' ' + @organizer.name 
                  %>
  <%end%>
  <h1><%= @organizer.name %></h1>
  <h3><%= @organizer.intro %></h3>
  <%= facebook_like organizer_path(:only_path => false), "top", "like" %>
</div>
<div class = "break"></div>

<%= image_tag @organizer.photo.url(:medium), :class => :organizer_photo %>

<%= simple_format @organizer.description %>


<p class = "break">
<% unless @organizer.website.blank? %>
  <strong><%=t '.website' =%>:</strong>
  <%= link_to @organizer.website, @organizer.website %>
</p>
<p>
<% end %>

  <strong><%=t '.contact' %>:</strong>
  <% unless @organizer.phone.blank? %>
    <br /><%= @organizer.phone%>
  <% end %>
  <% unless @organizer.email.blank? %>
  <br /><%= @organizer.email %>
  <% end %>
</p>


<h3><%= t '.upcoming' %></h3>

<% if @organizer.upcoming_events.blank? %>  
  <p><%= t('.at_the_moment') + ' ' + @organizer.name + ' ' + t('.has_no_events') %> 
  <% if current_user %>
    <% unless !current_user.organizers.include? @organizer and !current_user.is_admin? %>
      <%= link_to t('.new_event'), new_event_path %>.
    <% end %>
  <% end %>
  </p>
<% else %>
    <%= will_paginate( 
          @events,
          :renderer => GmailPaginationLinkRenderer,
          :first_label => t('will_paginate.first'),
          :previous_label => t('will_paginate.previous'),
          :next_label => t('will_paginate.next'),
          :last_label => t('will_paginate.last'),
          :summary_label => " %d #{t('will_paginate.to')} %d #{t('will_paginate.of')} %d "
          ) %>
  <%= calendar @events %>
  <%= will_paginate( 
          @events,
          :renderer => GmailPaginationLinkRenderer,
          :first_label => t('will_paginate.first'),
          :previous_label => t('will_paginate.previous'),
          :next_label => t('will_paginate.next'),
          :last_label => t('will_paginate.last'),
          :summary_label => " %d #{t('will_paginate.to')} %d #{t('will_paginate.of')} %d "
          ) %>
<% end %>

<p>
<%= link_to @organizer.name + t('.previous_events'), events_path(:organizer_id => @organizer.id, :start => :past) %>
</p>

<p>
<%= link_to t('.subscribe_rss') + ' ' + @organizer.name + t('app.s') + ' ' + t('.organizers_event'), :format => :rss, :only_path => false %>  
<%= link_to image_tag("rss_icon.gif", :alt => t('.rss_alt') + ' ' + @organizer.name), :format => :rss, :only_path => false %>
</p>

<p>
<%= link_to(t('.download_ics'), organizer_url(:only_path => false, :format => :ics ))  %>
</p>


<%= facebook_like organizer_path(:only_path => false), "bottom", "like" %>

<p>Jobbar du för <%= @organizer.name%>? Ansök om att bli administratör</p> TODO link




<% if current_user %>
  <% if current_user.authorized? @organizer %>
  
  </div><div class="post" id = "admin">
  <h2><%= t '.for_organizers'%></h2>
  
  <div class = "authorized">
    <%= button_to(  t('.edit'), 
                    edit_organizer_path(@organizer), 
                    :method => :get, 
                    :class => :organizer_user) %>
    <% if current_user.is_admin? %>
      <%= button_to(  t('.destroy'), 
                    @organizer, 
                    :confirm => t('app.are_you_sure') + ' ' +@organizer.name + '?', 
                    :method => :delete ) %>
    <%end%>

  


  
  <p>&nbsp;</p>

  <h3>Användare som vill bli administratörer för <%= @organizer.name %>:</h3>
  <% unless true  %> @organizer.memberships.find(:all, :conditions => ["prospect_user_id <> ? ", "null"]).blank?
    <p>Om du inte agerar så kommer användarna att plockas bort från listan efter ... veckor. TODO</p>
    <table class = "general">
      <% for membership in @organizer.memberships.find(:all, :conditions => false) %>TODO state
        <% user = User.find membership.prospect_user_id %>
        <tr class = "<%= cycle("even", "odd") %>">
          <td><%= image_tag avatar_url(user) %><br /></td>
          <td><%= link_to user.name , user %>:<br />
          <td>
              <%= button_to   t('.promote_prospect'), 
                              membership_promote_prospect_path(membership, 
                                                                :organizer_id => @organizer.id,
                                                                :user_id => user.id,
                                                                :membership_id => membership.id), 
                              :method => :put, 
                              %>                         
          </td>
          <td>
              <%= button_to t('.cancel_prospect'),    
                            membership_cancel_prospect_path(membership), 
                            :confirm => t('.confirm_cancel_prospect1') + user.name + t('.confirm_cancel_prospect2') + @organizer.name + t('.note_legal'), 
                            :method => :delete %> 
          </td>
        </tr>
      <% end %> 
    </table>
    <p>§ Liten text om att dela ut behöigheter. Den som du gör till administratör kommer att få samma behörighet som du och andra adminstratörer... Personen som ansökt om att bli adminstratör kommer att få ett mejl när du godkänner eller avslår ansökan. TODO</p>
  <%else%>
    <p>Just nu finns det inga ansökningar.</p>
  <%end%>

<% end %>
<% end %>

  <h3><%= t('.members_in') + ' ' + @organizer.name %>:</h3>
  <table class = "general">
     <tr>
      <th></th>
      <th><%= t '.email'%></th>
      <th><%= t '.first_name'%></th>
      <th><%= t '.last_name'%></th>
      <th></th>
    </tr>
    <% for user in @organizer.users %>
    <tr class = "<%= cycle("even", "odd") %>">
      <td><%= image_tag avatar_url(user) %><br /></td>
      <td><%= link_to user.email , user %></td>
      <td><%= link_to user.first_name , user %></td>
      <td><%= link_to user.last_name , user %></td>
      <td>
        <% unless user == current_user %>
          <%= button_to I18n.t('organizers.show.unmember') , membership_path(Membership.find(:first, :conditions => ["organizer_id = ? and user_id = ?", @organizer.id, user.id])), :confirm => I18n.t('organizers.show.sure_unmember') + user.name, :method => :delete %> 
        <%else%>
          <%= t '.dont_leave'%>
        <% end %>
      </td>
    </tr>
    <% end %> 
  </table>
</div> <!-- authorized -->


<%= content_for :right_column_bottom do %>  
  <div class = "box" id = "promote_municipality">
    <span class="heading"><%= t('.promote')%><br /> <%=@organizer.name%>:</span>
    <p>
      <%= link_to t('.subscribe_rss') + ' ' + @organizer.name + t('app.s') + ' ' + t('.organizers_event'), :format => :rss, :only_path => false %>  
      <%= link_to image_tag("rss_icon.gif", :alt => t('.rss_alt') + ' ' + @organizer.name), :format => :rss, :only_path => false %>
    </p>

    <p>
      <%= link_to(t('.download_ics'), organizer_url(:only_path => false, :format => :ics ))  %>
    </p>

    <p>
    <%= t('.share_as_iframe') %>
    </p>
    <%= text_area_tag( "id", h('<iframe src="' + organizer_url(:format => :ihtml) + '"  frameborder="1" ></iframe>'), :class => :iframe_me, :readonly => true) %>
  </div> <!-- /promote_organizer -->
<% end %>
