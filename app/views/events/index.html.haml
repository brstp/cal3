.content
  %article.article{:role => "main"}
    %header
      = render "flashes"   
    .search_container
      .search_box
        .search_heading
          .search_label
            Sök evenemang, ämne, plats, ...
          .clear_link
            - unless params[:q].blank? && params[:stop].blank? && params[:start].blank? && params[:category_facet_id].blank? && params[:organizer_id].blank? && params[:municipality_id].blank? && params[:cl].to_i == 0 && params[:ml].to_i == 0 && @to_date.blank? && @from_date.beginning_of_day == Time.zone.now.beginning_of_day
              = link_to "rensa sökningen", events_path
        = form_tag({:action => 'index'}, :method => 'get' )            
        = search_field_tag :q, params[:q]   
        = hidden_field_tag :municipality_id, params[:municipality_id]
        = hidden_field_tag :organizer_id, params[:organizer_id]
        = hidden_field_tag :category_facet_id, params[:category_facet_id]
        = hidden_field_tag :start, params[:start]
        = hidden_field_tag :stop, params[:stop]
        = hidden_field_tag :cl, params[:cl]
        = hidden_field_tag :ml, params[:ml]
        
        = #search_field_tag :search, "punk malmö juni"
        .submit_row 
          = submit_tag "Sök", :id => :event_search
  
      
      .three_cols
        - unless params[:organizer_id].blank?
          .facet_organizer
            %h5 arrangör
            %ul
              - for row in @organizer_facet_rows
                %li.selected_facet
                  %a{:href => url_for(params.merge({:organizer_id => nil})), :title => "Visa alla arrangörer..."}
                    %span.cancel_facet x
                    %span= "#{row.instance.to_s} (#{row.count.to_s})"
        .facet_column_category
          %h5 vad/ämne
          %ul
            - for row in @category_facet_rows
              - if row.value.to_i == params[:category_facet_id].to_i
                %li.selected_facet
                  %a{:href => url_for(params.merge({:category_facet_id => nil})), :title => "Visa fler ämnen..."}
                    %span.cancel_facet x
                    %span= "#{row.instance.and_mum.to_s} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{row.instance.and_mum.to_s} (#{row.count.to_s})", params.merge({:category_facet_id => row.instance.id}), :title => "Sök evenemang bara i kategorin #{row.instance.to_s}."
            - if (@category_facet_rows.count > (params[:cl].to_i + 5))
              %li.more_facets              
                =link_to( "• • •", params.merge({:cl => params[:cl].to_i + 7}), :title => "Visa fler ämneskategorier... ")              
        .facet_column_time
          %h5 när/datum
          %ul
            - for row in @stop_facet_rows
              - if row.value == params[:stop]
                %li.selected_facet
                  %a{:href => url_for(params.merge({:stop => nil})), :title => "Visa fler tidsperioder..."}
                    %span.cancel_facet x
                    %span= "#{t('when_facet.' + row.value.to_s)} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{t('when_facet.' + row.value.to_s)} (#{row.count.to_s})", params.merge({:stop => row.value}), :title => "Sök evenemang bara i #{t('when_facet.' + row.value.to_s)}."

            - if Timeliness.parse(@from_date).blank? 
              %li.facet_field
                Från och med: 
                - if Timeliness.parse(@to_date).blank?
                  = text_field_tag :from, l(Time.zone.now, :format => :date), :size => 11
                - else
                  = text_field_tag :from, "", :size => 11
            - else
              %li.facet_field.selected_facet
                %a{:href => url_for(params.merge({:from => nil})), :title => "Visa från dagens datum och framåt."}
                  %span.cancel_facet x
                  Från och med: 
                  - from_date = Timeliness.parse(@from_date)
                - unless from_date.blank?
                  = text_field_tag :from, l(from_date, :format => :date), :size => 14, :type => :date              
                - else
                  = text_field_tag :from, "", :size => 14, :type => :date              

            - if Timeliness.parse(@to_date).blank?
              %li.facet_field
                Till och med:
                =text_field_tag :to, "", :size => 14, :type => :date
            - else
              %li.facet_field.selected_facet
                %a{:href => url_for(params.merge({:to => nil})), :title => "Visa evenemang som ligger längre fram i tiden också."}
                  %span.cancel_facet x
                  Till och med:
                =text_field_tag :to, l(Timeliness.parse(@to_date), :format => :date), :size => 14, :type => :date

        .facet_column_location
          %h5 var/ort 
          %ul
            - for row in @municipality_facet_rows
              - if row.value.to_i == params[:municipality_id].to_i
                %li.selected_facet
                  %a{:href => url_for(params.merge({:municipality_id => nil})), :title => "Visa fler platser..."}
                    %span.cancel_facet x
                    %span= "#{row.instance.to_s} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{row.instance.to_s} (#{row.count.to_s})",params.merge({:municipality_id => row.instance.id}), :title => "Sök evenemang bara i #{row.instance.to_s}."
            - if (@municipality_facet_rows.count > (params[:ml].to_i + 5))      
              %li.more_facets              
                =link_to( "• • •", params.merge({:ml => params[:ml].to_i + 7}), :title => "Visa fler platser... ")                   


    = paginate @events
               
    - unless @events.blank?
      %p Här är #{@events.count} av #{@hit_numbers} evenemang:

      %table.mini_calendar
        %tbody
          - for event in @events
            %tr{:itemscope => true, :itemtype => "http://schema.org/Event"}
              %td
                <a class='inline_div' href='#{event_path event}' title='#{event.subject}. #{event.intro}'>
                .calendar_day
                  .weekday #{l(event.start_datetime, :format => :abbr_day_of_week)}
                  .day_of_month #{l(event.start_datetime, :format => :day_of_month)}
                  .month #{l(event.start_datetime, :format => :abbr_month_of_year)}
                </a>
              %td
                %span.event_row
                  - if event.start_datetime.beginning_of_year == Time.zone.now.beginning_of_year
                    = link_to "#{event.subject} (#{event.category.name}). #{event.organizer.name}, #{event.municipality.short_name}. Kl #{l(event.start_datetime, :format => :time)}.", event_path(event), :title => event.intro, :itemprop => :url
                  - else
                    = link_to "#{event.subject} (#{event.category.name}). #{event.organizer.name}, #{event.municipality.short_name}.  #{l(event.start_datetime)}.", event_path(event), :title => event.intro, :itemprop => :url                  
                  <meta itemprop="startDate" content="#{l(event.start_datetime, :format => :machine)}">
                  <meta itemprop="description" content="#{event.intro}}">
                  <meta itemprop="name" content="#{event.subject}}">
                  <meta itemprop="performer" content="#{event.organizer.name}}">
                  <meta itemprop="addressLocality" content="#{event.location}}">
      %p
        = paginate @events
      %p
        - if params[:q].present? || params[:municipality_id].present? || params[:organizer_id].present? || params[:start].present? || params[:stop].present? || params[:category_facet_id].present?
          = link_to "Rensa sökningen och visa alla evenemang.", events_path  
    - else
      - if params[:q].present? || params[:municipality_id].present? || params[:organizer_id].present? || params[:start].present? || params[:stop].present? || params[:category_facet_id].present?
        %p 
          Nej, vi hittar inga evenemang som matchar det du söker efter. Sorry. 
        %p
          = link_to "Rensa sökningen och börja om med att visa alla evenemang? ", events_path
      - else
        %p Nej, hur konstigt det än verkar vara så hittar vi inte några evenemang alls. Har du sökt med så hårda villkor att det inte blir några träffar? Eller har vi strulat till något?
    %p #{ link_to "Lägg in ett evenemang...", new_event_path }
  
  %aside{:role => "complementary"}
    = render 'aside_index'

- set_meta_tags :title => "Allom - evenemangskalender för alla sorters evenemang och aktiviteter.", :description => "Hitta saker att göra. Lägg in dina evenemang på evenemangskalendern Allom. Snabbt och enkelt. Kostnadsfritt konto."

