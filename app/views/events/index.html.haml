.content
  %article.article{:role => "main"}
    %header
      = render "flashes"   
      
      
    
    
      
      
    .search_container
      .search_box
        .search_heading
          .search_label
            Sök evenemang, ämne, plats, ...
          .clear_link
            - unless params[:q].blank? && params[:stop].blank? && params[:start].blank? && params[:category_facet_id].blank? && params[:organizer_id].blank? && params[:municipality_id].blank? && params[:cl].to_i == 0 && params[:ml].to_i == 0
              = link_to "rensa sökningen", events_path
        = form_tag({:action => 'index'}, :method => 'get' )            
        = search_field_tag :q, params[:q]   
        = hidden_field_tag :municipality_id, params[:municipality_id]
        = hidden_field_tag :organizer_id, params[:organizer_id]
        = hidden_field_tag :category_facet_id, params[:category_facet_id]
        = hidden_field_tag :start, params[:start]
        = hidden_field_tag :stop, params[:stop]
        = hidden_field_tag :cl, params[:cl]
        = hidden_field_tag :ml, params[:ml]
        
        = #search_field_tag :search, "punk malmö juni"
        .submit_row 
          = submit_tag "Sök", :id => :event_search
  
      .three_cols
        .facet_column_first
          %h5 vad/ämne
          %ul
            - for row in @category_facet_rows
              - if row.value.to_i == params[:category_facet_id].to_i
                %li.selected_facet
                  %a{:href => url_for(params.merge({:category_facet_id => nil})), :title => "Visa fler ämnen..."}
                    %span.cancel_facet x
                    %span= "#{row.instance.and_mum.to_s} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{row.instance.and_mum.to_s} (#{row.count.to_s})", params.merge({:category_facet_id => row.instance.id}), :title => "Sök evenemang bara i kategorin #{row.instance.to_s}."
            %li.more_facets              
              =link_to( "• • •", params.merge({:cl => params[:cl].to_i + 7}), :title => "Visa fler ämneskategorier... ")              
        .facet_column_second
          %h5 när/datum
          %ul
            - for row in @stop_facet_rows
              - if row.value == params[:stop]
                %li.selected_facet
                  %a{:href => url_for(params.merge({:stop => nil})), :title => "Visa fler tidsperioder..."}
                    %span.cancel_facet x
                    %span= "#{t('when_facet.' + row.value.to_s)} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{t('when_facet.' + row.value.to_s)} (#{row.count.to_s})", params.merge({:stop => row.value}), :title => "Sök evenemang bara i #{t('when_facet.' + row.value.to_s)}."
            %li.facet_field
              Från datum:
              =text_field_tag :from_date, "2012-09-27", :size => 11
            %li.facet_field
              Till datum:
              =text_field_tag :to_date, "2012-12-31", :size => 11

        .facet_column_third
          %h5 var/ort 
          %ul
            - for row in @municipality_facet_rows
              - if row.value.to_i == params[:municipality_id].to_i
                %li.selected_facet
                  %a{:href => url_for(params.merge({:municipality_id => nil})), :title => "Visa fler platser..."}
                    %span.cancel_facet x
                    %span= "#{row.instance.to_s} (#{row.count.to_s})"
              - else
                %li
                  = link_to "#{row.instance.to_s} (#{row.count.to_s})",params.merge({:municipality_id => row.instance.id}), :title => "Sök evenemang bara i #{row.instance.to_s}."
            %li.facet_field
              %label{:for => :within_km}
                Inom kilometer:
                =text_field_tag :within_km, "20", :size => 2
            %li.more_facets              
              =link_to( "• • •", params.merge({:ml => params[:ml].to_i + 7}), :title => "Visa fler platser... ")                   


    = paginate @events
               
    - unless @events.blank?
      %p Här är #{@events.count} av #{@hit_numbers} evenemang:

      %table.mini_calendar
        %tbody
          - for event in @events
            %tr{:itemscope => true, :itemtype => "http://schema.org/Event"}
              %td
                <a class='inline_div' href='#{event_path event}' title='#{event.subject}. #{event.intro}'>
                .calendar_day
                  .weekday #{l(event.start_datetime, :format => :abbr_day_of_week)}
                  .day_of_month #{l(event.start_datetime, :format => :day_of_month)}
                  .month #{l(event.start_datetime, :format => :abbr_month_of_year)}
                </a>
              %td
                %span.event_row
                  = link_to raw( event.subject + ' (' + event.category.name + ')' + '. ' + event.organizer.name + ', ' + event.municipality.short_name + '. ' + 'Kl.&nbsp;' + l(event.start_datetime, :format => :time) + '.' ), event_path(event), :title => event.intro, :itemprop => :url
                  <meta itemprop="startDate" content="#{l(event.start_datetime, :format => :machine)}">
                  <meta itemprop="description" content="#{event.intro}}">
                  <meta itemprop="name" content="#{event.subject}}">
                  <meta itemprop="performer" content="#{event.organizer.name}}">
                  <meta itemprop="addressLocality" content="#{event.location}}">
      %p
        = paginate @events
      %p
        - if params[:q].present? || params[:municipality_id].present? || params[:organizer_id].present? || params[:start].present? || params[:stop].present? || params[:category_facet_id].present?
          = link_to "Rensa sökningen och visa alla evenemang.", events_path  
    - else
      - if params[:q].present? || params[:municipality_id].present? || params[:organizer_id].present? || params[:start].present? || params[:stop].present? || params[:category_facet_id].present?
        %p 
          Nej, vi hittar inga evenemang som matchar det du söker efter. Sorry. 
        %p
          = link_to "Rensa sökningen och börja om med att visa alla evenemang? ", events_path
      - else
        %p Nej, hur konstigt det än verkar vara så hittar vi inte några evenemang alls. Vi ska kolla vad det beror på. Kom tillbaka om en stund och prova igen.
    %p #{ link_to "Lägg in ett evenemang...", new_event_path }
  
  %aside{:role => "complementary"}
    = render 'aside_index'

- set_meta_tags :title => "Allom - evenemangskalender för alla sorters evenemang och aktiviteter.", :description => "Hitta saker att göra. Lägg in dina evenemang på evenemangskalendern Allom. Snabbt och enkelt. Kostnadsfritt konto."

